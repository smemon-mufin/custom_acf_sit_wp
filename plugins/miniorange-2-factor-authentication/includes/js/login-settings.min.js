jQuery('#loginsettings').addClass('mo2f-subtab-active');
jQuery("#mo_2fa_two_fa").addClass("side-nav-active");
jQuery(document).ready(function ($) {
	jQuery(function () {
		jQuery("#mo2f_grace_hour").click(function () {
			jQuery("#mo2f_grace_period").focus();
		});
		jQuery("#mo2f_grace_day").click(function () {
			jQuery("#mo2f_grace_period").focus();
		});
	});
});
var nonce = loginSettings.nonce;
jQuery('#mo2f_enable2FA_save_button').click(function () {
	var saveButtonId = jQuery(this).attr('id');
	var enabledrole = [];
	$.each(jQuery("input[name='role']:checked"), function () {
		enabledrole.push($(this).val());
	});
	var eneble2FA = jQuery("#mo2f_enable2FA").is(":checked");
	var data = {
		'action': 'mo2f_login_settings_ajax',
		'option': 'mo2f_enable2FA_save_option',
		'nonce': nonce,
		'mo2f_enable_2fa_settings': eneble2FA,
		'enabledrole': enabledrole,
		'mo2f_graceperiod_value': jQuery('#mo2f_grace_period').val(),
		'mo2f_graceperiod_type': jQuery('input[name="mo2f_graceperiod_type"]:checked').val(),
		'mo2f_graceperiod_action': jQuery('input[name="mo2f_grace_period_action"]:checked').val(),
	};
	handleAjaxrequest(ajaxurl, data, saveButtonId);
});
jQuery('#mo2f_enable_graceperiod_save').click(function () {
	var saveButtonId = jQuery(this).attr('id');
	var eneblegraceperiod = jQuery("#mo2f_enable_graceperiod").is(":checked");
	var data = {
		'action': 'mo2f_login_settings_ajax',
		'option': 'mo2f_graceperiod_save_option',
		'nonce': nonce,
		'mo2f_enable_graceperiod_settings': eneblegraceperiod,
		'mo2f_graceperiod_value': jQuery('#mo2f_grace_period').val(),
		'mo2f_graceperiod_type': jQuery('input[name="mo2f_graceperiod_type"]:checked').val(),
		'mo2f_graceperiod_action': jQuery('input[name="mo2f_grace_period_action"]:checked').val(),
	};
	handleAjaxrequest(ajaxurl, data, saveButtonId);
});

function mo2f_showSettings(element) {
	if (jQuery(element).is(":checked")) {
		jQuery("#" + element.id + "_settings").slideDown();
		jQuery("#" + element.id + "_settings").css("display", "flex");
		jQuery("#" + element.id + "_save").css("display", "flex");
		jQuery("#" + element.id + "_save").show();
	} else {
        var singleSettingCheckboxIds = ["mo2f_disable_inline_2fa", "mo2f_mfa_login", "mo2f_enable_shortcodes"];
        if (element.id!='mo2f_enable2FA' && ! singleSettingCheckboxIds.includes(element.id)){
            jQuery("#" + element.id + "_settings").slideUp();
            jQuery("#" + element.id + "_save").css("display", "none");
            var data = {
                'action': 'mo2f_login_settings_ajax',
                'option': element.id + '_disable',
                'nonce': nonce,
            };
            if( element.id!='mo2f_select_methods' ){
                handleAjaxrequest(ajaxurl, data, element.id);
            }
            
        }
	
	}
}

jQuery('#mo2f_redirect_url_table').on('click', '#mo2f_add_custom_redirect_url', function () {
	var $lastRow = jQuery('#mo2f_redirect_url_table tr:last');
	$lastRow.find('#mo2f_add_custom_redirect_url').remove();
	$lastRow = jQuery('#mo2f_redirect_url_table tr:last');
	var $newRow = $lastRow.clone();
	$newRow.find('input').val('');
	$newRow.find('select').val('');
	$lastRow.after($newRow);
	$newRow.find('td:last').append('<button class="mo2f-add-url-button" id="mo2f_add_custom_redirect_url">+</button>');
});

jQuery('#mo2f_enable_custom_redirect_save_button').click(function () {
	var saveButtonId = jQuery(this).attr('id');
	var enableCustomRedirect = jQuery("#mo2f_enable_custom_redirect").is(":checked");
	var data = {
		'action': 'mo2f_login_settings_ajax',
		'option': 'mo2f_enable_custom_redirect_option',
		'nonce': nonce,
		'mo2f_enable_custom_redirect': enableCustomRedirect,
		'mo2f_redirect_url_for_users': jQuery("input[name=\"mo2f_redirect_url_for_users\"]:checked").val(),
		'mo2f_custom_redirect_url': jQuery("#redirect_url_all").val(),
	};
	handleAjaxrequest(ajaxurl, data, saveButtonId);
});

jQuery("input[type=\"checkbox\"]").click(function () {
	var checkboxId = jQuery(this).attr('id');
    var checkboxName = jQuery(this).attr('name');
	var singleSettingCheckboxIds = ["mo2f_disable_inline_2fa", "mo2f_mfa_login", "mo2f_enable_shortcodes"];
	if (singleSettingCheckboxIds.includes(checkboxId)) {
		var data = {
			'action': 'mo2f_login_settings_ajax',
			'option': checkboxId + '_option',
			'nonce': nonce,
			[checkboxId]: jQuery("#" + checkboxId).is(":checked"),
		};
		handleAjaxrequest(ajaxurl, data, checkboxId);
	}
    if(checkboxName == 'role'){
        if( jQuery("input[name=\"role\"]").is(":checked") ){
            document.getElementById('mo2f_enable2FA').checked = true;
        }    
    }
});

jQuery('#mo2f_enable_backup_methods_save_button').click(function () {
	var saveButtonId = jQuery(this).attr('id');
	var enabledBackupMethods = [];
	$.each(jQuery("input[name='mo2f_enabled_backup_method']:checked"), function () {
		enabledBackupMethods.push($(this).val());
	});
	var enableBackupLogin = jQuery("#mo2f_enable_backup_methods").is(":checked");
	var data = {
		'action': 'mo2f_login_settings_ajax',
		'option': 'mo2f_enable_backup_methods',
		'nonce': nonce,
		'mo2f_enable_backup_login': enableBackupLogin,
		'mo2f_enabled_backup_methods': enabledBackupMethods,
	};
	handleAjaxrequest(ajaxurl, data, saveButtonId);
});

function handleAjaxrequest(ajaxurl, data, saveButtonId) {
	jQuery.post(ajaxurl, data, function (response) {
		if (response['success']) {
			success_msg(response.data);
		} else {
			error_msg(response.data);
		}
	});
}

function success_msg(msg) {
    jQuery("#wpns_nav_message").empty();
    jQuery("#wpns_nav_message").append(
        "<div id='notice_div' class='overlay_success' style='z-index:9999'><div class='popup_text'>" +
            msg +
            "</div></div>"
    );
    window.onload = nav_popup();
}

function error_msg(msg) {
	jQuery("#wpns_nav_message").empty();
	jQuery("#wpns_nav_message").append(
		"<div id='notice_div' class='overlay_error'><div class='popup_text'>" +
			msg +
			"</div></div>"
	);
	window.onload = nav_popup();
}